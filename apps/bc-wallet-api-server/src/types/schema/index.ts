import {
  ariesProofRequests,
  assets,
  credentialAttributes,
  credentialDefinitions,
  credentialRepresentations,
  credentialSchemas,
  issuers,
  personas,
  relyingParties,
  revocationInfo,
  scenarios,
  showcases,
  stepActions,
  steps,
  tenant,
  users,
} from '../../database/schema'

// $inferSelect does not respect nullability of fields and the type has every field as required
// $inferInsert only provides fields that are notNull() or generated by default. This seems to be a bug in DrizzleORM or very not pleasant choice

export type User = typeof users.$inferSelect
export type NewUser = typeof users.$inferInsert & {
  // NewUser allows id to be preset
  userName?: string | null
  issuer?: string | null
  clientId?: string | null
}

export type Asset = typeof assets.$inferSelect
export type NewAsset = typeof assets.$inferInsert & { fileName?: string | null; description?: string | null }

export type Persona = Omit<typeof personas.$inferSelect, 'headshotImage' | 'bodyImage'> & {
  headshotImage: Asset | null
  bodyImage: Asset | null
}
export type NewPersona = Omit<typeof personas.$inferInsert, 'slug'> & {
  headshotImage?: string | null
  bodyImage?: string | null
  hidden: boolean
}

export type CredentialDefinition = Omit<
  typeof credentialDefinitions.$inferSelect,
  'icon' | 'type' | 'credentialSchema' | 'approvedBy'
> & {
  type: CredentialType
  icon?: Asset
  credentialSchema: CredentialSchema
  representations: CredentialRepresentation[]
  revocation?: RevocationInfo | null
  approvedBy?: User | null
  approvedAt?: Date | null
}

export type NewCredentialDefinition = Omit<typeof credentialDefinitions.$inferInsert, 'type'> & {
  type: CredentialType
  icon?: string | null
  representations?: NewCredentialRepresentation[] // TODO SHOWCASE-81 make required
  revocation?: NewRevocationInfo | null
  identifierType?: IdentifierType | null
  identifier?: string | null
}

export type CredentialAttribute = Omit<typeof credentialAttributes.$inferSelect, 'credentialSchema'> & {
  type: CredentialAttributeType
}
export type NewCredentialAttribute = Omit<typeof credentialAttributes.$inferInsert, 'credentialSchema'> & {
  type: CredentialAttributeType
}

export type CredentialSchema = typeof credentialSchemas.$inferSelect & {
  attributes: CredentialAttribute[]
}

export type NewCredentialSchema = typeof credentialSchemas.$inferInsert & {
  attributes: NewCredentialAttribute[]
  identifierType?: IdentifierType | null
  identifier?: string | null
}

export type CredentialRepresentation = Omit<typeof credentialRepresentations.$inferSelect, 'credentialDefinition'>
export type NewCredentialRepresentation = Omit<typeof credentialRepresentations.$inferInsert, 'credentialDefinition'>

export type RevocationInfo = Omit<typeof revocationInfo.$inferSelect, 'credentialDefinition'>
export type NewRevocationInfo = Omit<typeof revocationInfo.$inferInsert, 'credentialDefinition'>

export type RelyingParty = Omit<typeof relyingParties.$inferSelect, 'logo'> & {
  credentialDefinitions: CredentialDefinition[]
  logo: Asset | null
}
export type NewRelyingParty = Omit<typeof relyingParties.$inferInsert, 'logo'> & {
  credentialDefinitions: string[]
  organization?: string | null
  logo?: string | null
}

export type Issuer = Omit<typeof issuers.$inferSelect, 'logo'> & {
  credentialDefinitions: CredentialDefinition[]
  credentialSchemas: CredentialSchema[]
  logo: Asset | null
}
export type NewIssuer = Omit<typeof issuers.$inferInsert, 'logo'> & {
  credentialDefinitions: string[]
  credentialSchemas: string[]
  organization?: string | null
  logo?: string | null
}

export enum CredentialType {
  ANONCRED = 'ANONCRED',
}

export enum CredentialAttributeType {
  STRING = 'STRING',
  INTEGER = 'INTEGER',
  FLOAT = 'FLOAT',
  BOOLEAN = 'BOOLEAN',
  DATE = 'DATE',
}

export enum RelyingPartyType {
  ARIES = 'ARIES',
}

export enum IdentifierType {
  DID = 'DID',
}

export enum Source {
  IMPORTED = 'IMPORTED',
  CREATED = 'CREATED',
}

export enum IssuerType {
  ARIES = 'ARIES',
}

export enum StepType {
  HUMAN_TASK = 'HUMAN_TASK',
  SERVICE = 'SERVICE',
  SCENARIO = 'SCENARIO',
}

export enum StepActionType {
  ARIES_OOB = 'ARIES_OOB',
  ACCEPT_CREDENTIAL = 'ACCEPT_CREDENTIAL',
  SETUP_CONNECTION = 'SETUP_CONNECTION',
  CHOOSE_WALLET = 'CHOOSE_WALLET',
  BUTTON = 'BUTTON',
}

export enum ScenarioType {
  ISSUANCE = 'ISSUANCE',
  PRESENTATION = 'PRESENTATION',
}

export type IssuanceScenario = Omit<typeof scenarios.$inferSelect, 'relyingParty' | 'issuer' | 'bannerImage'> & {
  personas: Persona[]
  steps: Step[]
  issuer?: Issuer | null
  bannerImage?: Asset | null
}
export type NewIssuanceScenario = Omit<typeof scenarios.$inferInsert, 'relyingParty' | 'scenarioType' | 'slug'> & {
  personas: string[]
  issuer: string
  steps: NewStep[]
  bannerImage?: string | null
  hidden: boolean
}

export type PresentationScenario = Omit<typeof scenarios.$inferSelect, 'relyingParty' | 'issuer' | 'bannerImage'> & {
  personas: Persona[]
  steps: Step[]
  relyingParty?: RelyingParty | null
  bannerImage?: Asset | null
}
export type NewPresentationScenario = Omit<typeof scenarios.$inferInsert, 'issuer' | 'scenarioType' | 'slug'> & {
  personas: string[]
  relyingParty: string
  steps: NewStep[]
  bannerImage?: string | null
  hidden: boolean
}

export type StepActionTypes =
  | StepAction
  | AcceptCredentialAction
  | ButtonAction
  | AriesOOBAction
  | SetupConnectionAction
  | ChooseWalletAction
export type NewStepActionTypes =
  | NewStepAction
  | NewAcceptCredentialAction
  | NewButtonAction
  | NewAriesOOBAction
  | NewSetupConnectionAction
  | NewChooseWalletAction

export type Step = Omit<typeof steps.$inferSelect, 'asset'> & {
  actions?: StepActionTypes[]
  asset?: Asset | null
}
export type NewStep = Omit<typeof steps.$inferInsert, 'scenario'> & {
  asset?: string | null
  actions?: NewStepActionTypes[]
  subScenario?: string | null
  credentialDefinitionIdentifierType?: IdentifierType | null
  credentialDefinitionIdentifier?: string | null
}
export type StepAction = typeof stepActions.$inferSelect
export type NewStepAction = Omit<typeof stepActions.$inferInsert, 'step'>

export type AcceptCredentialAction = Omit<typeof stepActions.$inferSelect, 'goToStep'> & {
  actionType: StepActionType.ACCEPT_CREDENTIAL
  credentialDefinitionId: string
  connectionId?: string | null
}
export type NewAcceptCredentialAction = Omit<typeof stepActions.$inferInsert, 'step' | 'goToStep'> & {
  actionType: StepActionType.ACCEPT_CREDENTIAL
  credentialDefinitionId: string
  connectionId?: string | null
}

export type ButtonAction = Omit<typeof stepActions.$inferSelect, 'credentialDefinitionId' | 'connectionId'> & {
  actionType: StepActionType.BUTTON
  goToStep?: string | null
}
export type NewButtonAction = Omit<
  typeof stepActions.$inferInsert,
  'step' | 'credentialDefinitionId' | 'connectionId'
> & {
  actionType: StepActionType.BUTTON
  goToStep?: string | null
}

export type AriesOOBAction = Omit<typeof stepActions.$inferSelect, 'proofRequest'> & {
  actionType: StepActionType.ARIES_OOB
  credentialDefinitionId: string
  proofRequest?: AriesProofRequest | null
}
export type NewAriesOOBAction = Omit<typeof stepActions.$inferInsert, 'step' | 'proofRequest'> & {
  actionType: StepActionType.ARIES_OOB
  proofRequest: NewAriesProofRequest
}

export type SetupConnectionAction = Omit<
  typeof stepActions.$inferSelect,
  'credentialDefinitionId' | 'connectionId' | 'goToStep'
> & {
  actionType: StepActionType.SETUP_CONNECTION
}
export type NewSetupConnectionAction = Omit<
  typeof stepActions.$inferInsert,
  'step' | 'credentialDefinitionId' | 'connectionId' | 'goToStep'
> & {
  actionType: StepActionType.SETUP_CONNECTION
}

export type ChooseWalletAction = Omit<
  typeof stepActions.$inferSelect,
  'credentialDefinitionId' | 'connectionId' | 'goToStep'
> & {
  actionType: StepActionType.CHOOSE_WALLET
}
export type NewChooseWalletAction = Omit<
  typeof stepActions.$inferInsert,
  'step' | 'credentialDefinitionId' | 'connectionId' | 'goToStep'
> & {
  actionType: StepActionType.CHOOSE_WALLET
}

export type AriesRequestCredentialAttribute = {
  attributes?: string[]
  restrictions?: string[]
}

export type AriesRequestCredentialPredicate = {
  name?: string
  type?: string
  value?: string
  restrictions?: string[]
}

export type AriesProofRequest = typeof ariesProofRequests.$inferSelect
export type NewAriesProofRequest = Omit<typeof ariesProofRequests.$inferInsert, 'stepAction'> & {
  attributes?: Record<string, AriesRequestCredentialAttribute>
  predicates?: Record<string, AriesRequestCredentialPredicate>
}

export type Tenant = typeof tenant.$inferSelect
export type NewTenant = typeof tenant.$inferInsert

export type Showcase = Omit<typeof showcases.$inferSelect, 'bannerImage' | 'createdBy' | 'approvedBy'> & {
  scenarios: Scenario[]
  personas: Persona[]
  bannerImage?: Asset | null
  createdBy?: User | null
  approvedBy?: User | null
  approvedAt?: Date | null
}

export type NewShowcase = Omit<typeof showcases.$inferInsert, 'slug'> & {
  scenarios: string[]
  credentialDefinitions?: string[] // No longer in use
  personas: string[]
  bannerImage?: string | null
  hidden: boolean
  completionMessage?: string | null
  createdBy?: string | null
}

export type Scenario = IssuanceScenario | PresentationScenario
export type NewScenario = NewIssuanceScenario | NewPresentationScenario

export enum ShowcaseStatus {
  PENDING = 'PENDING',
  ACTIVE = 'ACTIVE',
  ARCHIVED = 'ARCHIVED',
}
